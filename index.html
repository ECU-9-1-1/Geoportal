<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Alertas de Emergencia</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .sidebar {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            height: 600px;
            overflow-y: auto;
        }
        .header {
            background-color: #005c29;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            line-height: 1.8;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="bi bi-geo-alt-fill"></i> Geoportal de Alertas de Emergencia</h1>
            <p class="lead">Visualización en tiempo real de alertas</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div id="map"></div>
            </div>
            <div class="col-md-4">
                <div class="sidebar">
                    <h4>Filtros de Alertas</h4>
                    <div class="mb-3">
                        <label for="emergencyType" class="form-label">Tipo de Alerta</label>
                        <select class="form-select" id="emergencyType">
                            <option value="all">Todos los tipos</option>
                            <!-- Opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">Rango de Fechas</label>
                        <input type="date" class="form-control" id="startDate">
                        <input type="date" class="form-control mt-2" id="endDate">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Prioridad</label>
                        <select class="form-select" id="priority">
                            <option value="all">Todas</option>
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" id="applyFilters">
                        <span id="filterText">Aplicar Filtros</span>
                        <span id="filterLoading" class="loading" style="display: none;"></span>
                    </button>
                    
                    <div class="mt-4">
                        <h5>Estadísticas</h5>
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total de alertas</h6>
                                <p class="card-text fs-4" id="totalAlerts">0</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Distribución por tipo</h6>
                                <div id="typeDistribution">
                                    <small>Cargando datos...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Registros de Alertas</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="alertsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tipo</th>
                                        <th>Fecha/Hora</th>
                                        <th>Ubicación</th>
                                        <th>Prioridad</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Configuración de Supabase con tus credenciales
        const SUPABASE_URL = "https://dmlpacanmmccpikaysvm.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtbHBhY2FubW1jY3Bpa2F5c3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTQzNjY0MjQsImV4cCI6MjAwOTk0MjQyNH0.2lFYM3bDwLUggK8GqKx_7BVN9qH0pYQwEjT7xazW0FM";
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Coordenadas iniciales (Santo Domingo, Ecuador)
        const initialCoords = [-0.252, -79.175];
        
        // Inicializar mapa
        const map = L.map('map').setView(initialCoords, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        const emergencyLayer = L.layerGroup().addTo(map);

        // Función para cargar alertas desde Supabase
        async function loadAlerts(filters = {}) {
            try {
                showLoading(true);
                
                let query = supabase
                    .from('alertas_emergencia')
                    .select('*', { count: 'exact' });
                
                // Aplicar filtros
                if (filters.type && filters.type !== 'all') {
                    query = query.eq('tipo', filters.type);
                }
                
                if (filters.priority && filters.priority !== 'all') {
                    query = query.eq('prioridad', filters.priority);
                }
                
                if (filters.startDate && filters.endDate) {
                    query = query.gte('fecha_hora', filters.startDate)
                               .lte('fecha_hora', filters.endDate);
                }
                
                const { data, error, count } = await query;
                
                if (error) throw error;
                
                return {
                    alerts: data || [],
                    total: count || 0
                };
            } catch (error) {
                console.error('Error al cargar alertas:', error);
                alert('Error al cargar datos. Ver consola para detalles.');
                return { alerts: [], total: 0 };
            } finally {
                showLoading(false);
            }
        }

        // Función para mostrar alertas en el mapa
        function displayAlerts(alerts) {
            emergencyLayer.clearLayers();
            
            alerts.forEach(alert => {
                const marker = L.circleMarker([alert.latitud, alert.longitud], {
                    radius: 8,
                    fillColor: getColorByType(alert.tipo),
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(emergencyLayer);
                
                marker.bindPopup(`
                    <b>Tipo:</b> ${alert.tipo}<br>
                    <b>Fecha:</b> ${formatDate(alert.fecha_hora)}<br>
                    <b>Dirección:</b> ${alert.direccion || 'No especificada'}<br>
                    <b>Prioridad:</b> ${alert.prioridad}<br>
                    <b>Descripción:</b> ${alert.descripcion || 'Sin descripción'}
                `);
            });
            
            updateStatistics(alerts);
            updateTable(alerts);
        }

        // Función auxiliar para formatear fecha
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        // Función para obtener color según tipo de alerta
        function getColorByType(type) {
            const typeColors = {
                'incendio': '#ff4000',
                'accidente': '#ffcc00',
                'delito': '#ff0000',
                'medica': '#0066ff',
                'natural': '#00aa00',
                'violencia': '#990099',
                'otro': '#666666'
            };
            
            return typeColors[type.toLowerCase()] || '#666666';
        }

        // Función para actualizar estadísticas
        function updateStatistics(alerts) {
            $('#totalAlerts').text(alerts.length);
            
            // Calcular distribución por tipo
            const typeCount = {};
            alerts.forEach(alert => {
                typeCount[alert.tipo] = (typeCount[alert.tipo] || 0) + 1;
            });
            
            let distributionHtml = '';
            for (const [type, count] of Object.entries(typeCount)) {
                const percentage = (count / alerts.length * 100).toFixed(1);
                distributionHtml += `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${type}</span>
                        <span>${count} (${percentage}%)</span>
                    </div>
                    <div class="progress mb-2" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${percentage}%; background-color: ${getColorByType(type)};">
                        </div>
                    </div>
                `;
            }
            
            $('#typeDistribution').html(distributionHtml);
        }

        // Función para actualizar la tabla
        function updateTable(alerts) {
            const tableBody = $('#alertsTable tbody');
            tableBody.empty();
            
            alerts.forEach(alert => {
                const row = `
                    <tr>
                        <td>${alert.id}</td>
                        <td><span class="badge" style="background-color: ${getColorByType(alert.tipo)}">${alert.tipo}</span></td>
                        <td>${formatDate(alert.fecha_hora)}</td>
                        <td>${alert.direccion || 'No especificada'}</td>
                        <td>
                            ${alert.prioridad === 'alta' ? '<span class="badge bg-danger">Alta</span>' : 
                              alert.prioridad === 'media' ? '<span class="badge bg-warning text-dark">Media</span>' : 
                              '<span class="badge bg-secondary">Baja</span>'}
                        </td>
                        <td>${alert.descripcion || 'Sin descripción'}</td>
                    </tr>
                `;
                tableBody.append(row);
            });
        }

        // Función para cargar tipos de alertas disponibles
        async function loadAlertTypes() {
            try {
                const { data, error } = await supabase
                    .from('alertas_emergencia')
                    .select('tipo')
                    .not('tipo', 'is', null);
                
                if (error) throw error;
                
                const uniqueTypes = [...new Set(data.map(item => item.tipo))];
                const typeSelect = $('#emergencyType');
                
                uniqueTypes.forEach(type => {
                    typeSelect.append(`<option value="${type}">${type}</option>`);
                });
            } catch (error) {
                console.error('Error al cargar tipos:', error);
            }
        }

        // Función para mostrar/ocultar carga
        function showLoading(show) {
            if (show) {
                $('#filterText').hide();
                $('#filterLoading').show();
                $('#applyFilters').prop('disabled', true);
            } else {
                $('#filterText').show();
                $('#filterLoading').hide();
                $('#applyFilters').prop('disabled', false);
            }
        }

        // Función para obtener filtros actuales
        function getCurrentFilters() {
            return {
                type: $('#emergencyType').val(),
                priority: $('#priority').val(),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val()
            };
        }

        // Inicialización
        $(document).ready(async function() {
            // Cargar tipos de alertas disponibles
            await loadAlertTypes();
            
            // Carga inicial de datos
            const { alerts } = await loadAlerts();
            displayAlerts(alerts);
            
            // Configurar evento de filtros
            $('#applyFilters').click(async function() {
                const filters = getCurrentFilters();
                const { alerts } = await loadAlerts(filters);
                displayAlerts(alerts);
            });
            
            // Configurar fecha por defecto (últimos 7 días)
            const today = new Date();
            const lastWeek = new Date();
            lastWeek.setDate(today.getDate() - 7);
            
            $('#startDate').val(lastWeek.toISOString().split('T')[0]);
            $('#endDate').val(today.toISOString().split('T')[0]);
        });

        // Añadir leyenda al mapa
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            const types = {
                'incendio': 'Incendio',
                'accidente': 'Accidente',
                'delito': 'Delito',
                'medica': 'Emergencia Médica',
                'natural': 'Desastre Natural',
                'violencia': 'Violencia',
                'otro': 'Otro'
            };
            
            div.innerHTML = '<h6>Leyenda</h6>';
            
            for (const [type, label] of Object.entries(types)) {
                div.innerHTML += 
                    `<i style="background:${getColorByType(type)}"></i> ${label}<br>`;
            }
            
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
